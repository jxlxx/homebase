# Setup Guide

This document walks through bootstrapping remote state, provisioning Linode infrastructure with Terragrunt, and deploying services.

## 1. Prerequisites

- Terraform or OpenTofu >= 1.5
- Terragrunt >= 0.55
- Docker + Docker Compose plugin on your workstation (to test locally if desired)
- Linode account with:
  - Personal access token (`LINODE_TOKEN`) that can manage Object Storage, Instances, and DNS
  - (Optional) Cloud firewall/security group rights if you extend infra later
- S3/Object Storage credentials will be generated by the bootstrap step. Store them securely.

Export the following before running commands (or supply via a secrets manager):

```bash
export LINODE_TOKEN="<personal access token>"
export LINODE_ROOT_PASS="<root password required by Linode during instance creation>"
```

## 2. Bootstrap remote state

1. Review/override defaults in `bootstrap/terraform.tfvars.example`, copy it to `bootstrap/terraform.tfvars`, and set the bucket label, cluster, and access key label you prefer.
2. Run Terraform locally to create the Object Storage bucket and dedicated access keys:

   ```bash
   cd bootstrap
   terraform init
   terraform apply
   ```

3. Capture the outputs:

   - `bucket_label`, `bucket_cluster`, `bucket_endpoint`
   - `access_key_id`, `secret_access_key`

   Store the key/secret someplace safe – the secret is only shown once.

4. Update `infra/live/terragrunt.hcl` with the bucket label, region/cluster, and endpoint from the outputs.
5. Export the Object Storage credentials (Terragrunt reads them when configuring the S3 backend):

   ```bash
   export LINODE_OBJ_ACCESS_KEY="$(terraform -chdir=bootstrap output -raw access_key_id)"
   export LINODE_OBJ_SECRET_KEY="$(terraform -chdir=bootstrap output -raw secret_access_key)"
   ```

## 3. Provision infrastructure with Terragrunt

Terragrunt directories live under `infra/live`.

1. **Apps node** – creates a single Linode where all Docker workloads run:

   ```bash
   cd infra/live/prod/apps-node-1
   terragrunt init
   terragrunt apply
   ```

   This renders `infra/cloud-init/apps-node.yaml` with your repo URL and hands it to Linode as user data. The node auto-installs Docker, clones this repo, and launches Traefik + all service stacks via `services/deploy-all.sh`.

2. **DNS** – creates A records for the services (plus the Authelia portal at `auth.jxlxx.org`) pointing at the node public IP:

   ```bash
   cd ../dns
   terragrunt init
   terragrunt apply
   ```

3. Repeat for new stacks/environments by adding more folders under `infra/live` with their own Terragrunt configs.

## 4. Manage services on the node

Once cloud-init finishes, SSH into the instance (replace IP with the value Terragrunt outputs):

```bash
ssh root@<apps-node-ip>
cd /srv/homebase/services
```

Copy each `.env.example` to `.env` inside the corresponding service directory and fill in secrets (database passwords, Authelia secrets, ACME email, etc.). Then redeploy:

```bash
./deploy-all.sh
```

`deploy-all.sh` creates the shared `proxy` Docker network if needed and sequentially runs `docker compose up -d` for Traefik, Authelia, Home, Gitea, Matrix, HedgeDoc, and Excalidraw.

To manage stacks individually:

```bash
docker compose -f services/gitea/docker-compose.yml pull
docker compose -f services/gitea/docker-compose.yml up -d
```

Log files live under `/var/lib/docker/containers/<id>/<id>-json.log` or use `docker logs <service>`.

## 5. Authentication management

- Authelia config is under `services/auth/config/configuration.yml`.
- Users are defined in `services/auth/config/users_database.yml`. To add a user, generate a password hash (`docker run authelia/authelia:4.38 authelia hash-password 'MyPass'`) and append a new user entry with that hash.
- Update `session.secret` and `storage.encryption_key` with long random strings or use environment overrides via `.env`.
- Traefik attaches the `authelia-auth@file` middleware (defined in `services/traefik/traefik_dynamic.yml`) to every router, so all sites require login.

## 6. Updating domains or certificates

- Change hostnames in service Traefik labels, Authelia `configuration.yml`, and `.env` files.
- Update `infra/live/prod/dns/terragrunt.hcl` with new records, then rerun `terragrunt apply` in that directory.
- Traefik automatically requests/renews Let’s Encrypt certificates and stores them in `services/traefik/letsencrypt/acme.json`.

## 7. Destroying resources

To tear down infrastructure:

```bash
cd infra/live/prod/dns
terragrunt destroy

cd ../apps-node-1
terragrunt destroy
```

Finally, remove the Object Storage bucket via `terraform destroy` inside `bootstrap/` if you no longer need remote state (ensure all states are deleted first).
