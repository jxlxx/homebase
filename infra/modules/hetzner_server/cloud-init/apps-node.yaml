#cloud-config
apt:
    sources:
      docker.list:
        source: deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu noble stable

write_files:
  - path: /srv/services/.env
    content: |
      # placeholder for shared environment overrides
    owner: root:root
    permissions: '0644'

runcmd:
  - sudo snap install helix --classic
  - sudo install -m 0755 -d /etc/apt/keyrings
  - sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - sudo chmod a+r /etc/apt/keyrings/docker.gpg
  - sudo apt-get update
  - sudo DEBIAN_FRONTEND=noninteractive apt-get install -y git docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker --now
  - mkdir -p /opt
  - git clone --branch ${repo_branch} ${repo_url} /opt/homebase
  - echo "ACME_CA_SERVER=${acme_ca_server}" >> /opt/homebase/services/traefik/.env
  - cd /opt/homebase && docker compose -f services/traefik/docker-compose.yml up -d
  - cd /opt/homebase/services && chmod +x deploy-all.sh && ./deploy-all.sh
